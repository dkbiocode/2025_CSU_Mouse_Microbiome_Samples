configfile: "config.yaml"
DATA_DIR = config["esdaile_data_dir"]
WORK_DIR = config["scratch_data_dir"]

rule all:
	input:
		WORK_DIR + "/04_ancombc_number_of_paths.qzv",
		WORK_DIR + "/04_da_barplot_number_of_paths.qzv"

rule collapse_to_species: 
	input:
		table=f"{WORK_DIR}/03_table_mouse_fecal_samples_filter_taxa_samples_3_reads_100_greengenes.qza",
		taxon=f"{WORK_DIR}/03_mouse_fecal_samples_taxonomy_greengenes.qza"
	output:
		f"{WORK_DIR}/04_table_collapsed_L7.qza"
	shell:
		"qiime taxa collapse \
		--i-table {input.table} \
		--i-taxonomy {input.taxon} \
		--p-level 7 \
		--o-collapsed-table {output}"


rule run_ancom:
	input:
		table=f"{WORK_DIR}/04_table_collapsed_L7.qza",
		meta="metadata.txt"
	output:
		f"{WORK_DIR}/04_ancombc_number_of_paths.qza"
	shell:
		"""qiime composition ancombc \
		--i-table {input.table} \
		--m-metadata-file {input.meta} \
		--p-formula 'pregnancy_status' \
		--p-p-adj-method 'bonferroni' \
		--o-differentials {output}"""

rule vis_ancom:
	input: 
		f"{WORK_DIR}/04_ancombc_number_of_paths.qza"
	output:
		f"{WORK_DIR}/04_ancombc_number_of_paths.qzv"
	shell: 
		"qiime composition tabulate \
		--i-data {input} \
		--o-visualization {output} "

rule ancom_barplot:
	input:
		f"{WORK_DIR}/04_ancombc_number_of_paths.qza"
	output:
		f"{WORK_DIR}/04_da_barplot_number_of_paths.qzv"
	shell:
		"""qiime composition da-barplot \
		--i-data {input} \
		--p-significance-threshold 0.001 \
		--p-label-limit 5000 \
		--o-visualization {output}"""
	
